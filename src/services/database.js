// Generated by CoffeeScript 1.10.0
(function() {
  var Firebase, Promise, R, Rx, base, dot, entities, getStatus, getTeamId, getUser, getUserBackDateTimeRef, getUserBackRef, getUserId, getUserRef, getUserState, getUserStateRef, getUserStatus, getUserStatusRef, log, makeUserObject, message, response$, setUserBack, setUserBackDateTime, setUserState, setUserStatus, teams;

  Firebase = require('firebase');

  Promise = require('promise');

  R = require('ramda');

  Rx = require('rx');

  dot = require('../misc/helpers').dot;

  log = require('../misc/util').log;

  base = new Firebase('https://werebot.firebaseio.com/');

  teams = base.child('teams');


  /* PRIVATE */

  getTeamId = dot('team');

  getUserId = dot('user');

  getStatus = dot('status');

  getUserRef = function(teamId, userId) {
    return teams.child(teamId).child('users/' + userId);
  };

  getUserStateRef = function(teamId, userId) {
    return getUserRef(teamId, userId).child('state');
  };

  getUserStatusRef = function(teamId, userId) {
    return getUserRef(teamId, userId).child('status');
  };

  getUserBackRef = function(teamId, userId) {
    return getUserRef(teamId, userId).child('back');
  };

  getUserBackDateTimeRef = function(teamId, userId) {
    return getUserRef(teamId, userId).child('backDateTime');
  };

  makeUserObject = function(userId, snapshot) {
    var user;
    user = {};
    user[userId] = snapshot.val();
    return user;
  };


  /* PUBLIC */

  response$ = new Rx.Subject();

  getUser = (function(_this) {
    return function(message) {
      return new Promise(function(resolve, reject) {
        return getUserRef(getTeamId(message), getUserId(message)).once('value', function(snapshot) {
          var user;
          user = R.merge(snapshot.val(), {
            id: getUserId(message)
          });
          return resolve(user);
        });
      });
    };
  })(this);

  getUserState = (function(_this) {
    return function(message) {
      return new Promise(function(resolve, reject) {
        return getUserStateRef(getTeamId(message), getUserId(message)).once('value', function(snapshot) {
          var state;
          state = snapshot.val() == null ? 'idle' : snapshot.val();
          resolve(state);
          return response$.onNext(state);
        });
      });
    };
  })(this);

  getUserStatus = (function(_this) {
    return function(message) {
      return new Promise(function(resolve, reject) {
        return getUserStatusRef(getTeamId(message), getUserId(message)).once('value', function(snapshot) {
          var status;
          status = snapshot.val();
          log(status);
          resolve(status);
          return response$.onNext(status);
        });
      });
    };
  })(this);

  setUserStatus = function(message, status) {
    return getUserStatusRef(getTeamId(message), getUserId(message)).set(status);
  };

  setUserState = function(message, state) {
    return getUserStateRef(getTeamId(message), getUserId(message)).set(state);
  };

  setUserBack = function(message, back) {
    return getUserBackRef(getTeamId(message), getUserId(message)).set(back);
  };

  setUserBackDateTime = function(message, backDateTime) {
    return getUserBackDateTimeRef(getTeamId(message), getUserId(message)).set(backDateTime);
  };

  module.exports = {
    response$: response$.share(),
    getUserState: getUserState,
    getUser: getUser,
    setUserStatus: setUserStatus,
    setUserState: setUserState,
    setUserBack: setUserBack,
    setUserBackDateTime: setUserBackDateTime
  };


  /* TEST */

  message = {
    team: 'T0123',
    user: 'U0ABC'
  };

  entities = {
    status: 'at work'
  };

}).call(this);
