// Generated by CoffeeScript 1.10.0
(function() {
  var Promise, R, intents, log, parseEntities, processBundle, processIntent, queries, ref, replies, setUserState, setUserStatus;

  R = require('ramda');

  Promise = require('promise');

  log = require('../misc/util').log;

  ref = require('../services/database'), setUserStatus = ref.setUserStatus, setUserState = ref.setUserState;


  /* PRIVATE */

  parseEntities = R.compose(R.map(R.prop('value')), R.map(R.nth(0)));

  replies = {
    intents: {
      unknown: "Sorry, didn't quite get that. Could you please rephrase that?",
      set_self_status: "Ok, got it!"
    }
  };

  queries = {
    back: "When do you expect to be back?"
  };

  intents = {
    'set_self_status': function(message, entities) {
      var reply;
      setUserStatus(message, entities);
      reply = [replies.intents.set_self_status];
      if (entities.back == null) {
        setUserState(message, 'bot_query_back');
        reply.push([queries.back]);
      } else {
        setUserState(message, 'idle');
      }
      return reply.join("\n");
    }
  };

  processIntent = function(intent, message, entities) {
    if (intents[intent] != null) {
      return intents[intent](message, entities);
    } else {
      return console.error("intent not found");
    }
  };


  /* PUBLIC */

  processBundle = function(bundle) {
    return new Promise((function(_this) {
      return function(resolve, reject) {
        var confidence, entities, intent, message, outcome, reply;
        message = bundle.message, outcome = bundle.outcome;
        intent = outcome.intent, confidence = outcome.confidence;
        entities = parseEntities(outcome.entities);
        if (confidence < 0.5 || intent === 'UNKNOWN') {
          reply = replies.intents.unknown;
        } else {
          reply = processIntent(intent, message, entities);
        }
        return resolve(R.merge(bundle, {
          reply: reply
        }));
      };
    })(this));
  };

  module.exports = {
    processBundle: processBundle
  };

}).call(this);
